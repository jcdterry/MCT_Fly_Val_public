---
title: "Predictions Under Fluctuating Temperature"
author: "Chris Terry"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

This script looks at how fluctuating envrironments impact coexistence predictions at each mean temperature. It broadly following Ellner et al (2019)'s https://onlinelibrary.wiley.com/doi/full/10.1111/ele.13159 method of simulating. 

Given  preceding analyses, I will just look at whether PAL is able in invade an equilibrium population of PAN, since this is the key transition of interest.

# Loading Values

Finding fitted values of key parameters at each temperature, including changes in zero-inflation. (This essentially assumes a large number of vials.)

```{r}
Av_PAL_vals <- read_csv('../Tables/CompositeParam_Temps_PAL.csv') %>%
  filter(  Temp %in% seq(22.5,28.7, by =0.1) ) %>%
  select(Temp, 
         PAL_lambda_av = PAL_lambda  ,
         PAL_alphaii_av = PAL_alphaii,
         PAL_alphaij_av = PAL_alphaij)

Av_PAN_vals <- read_csv('../Tables/CompositeParam_Temps_PAN.csv') %>%
  filter(  Temp %in% seq(22.5,28.7, by =0.1) ) %>%
  select(Temp, 
         PAN_lambda_av =  PAN_lambda  ,
         PAN_alphaii_av = PAN_alphaii,
         PAN_alphaij_av = PAN_alphaij)
```

# Simulation 

Process at each temperature:

- Generate temperature regime
- Iterate PAN numbers in monoculture
- Discard burn-in period
- vector of PAL growth rates with these temperatures and PAN densities
- Calculate geometric average of PAL growth rates 

Also calculating without variable temperature, to check variability is having an effect. 

```{R}
MidTempDF <- data.frame( MidTemp = seq(from = 24,
                                       to = 27,
                                       by = 0.1),
                         MeanPAN_FLUC = NA, 
                         PAL_Growth_FLUC = NA,
                         MeanPAN_FIX = NA, 
                         PAL_Growth_FIX = NA)

N = 1000
Flucts <-   sample(c( -1.5, 0, 1.5), replace = TRUE, N)
## NB using r as shorthand for population growth rate (Nt/Nt+1, normally lambda), not as Instantaneous population growth rate

for( i in 1:nrow( MidTempDF)){
  
  #####
  # Under Fluctuations 
  TempSeq = MidTempDF$MidTemp[i]+Flucts
  left_join(data.frame(Temp = TempSeq), Av_PAN_vals, by = 'Temp') -> ParamSeqDF
  
  # PAN counts
  Pop_Vec = rep(NA,N)
  Pop_Vec[1] <- 10
  for(t in 2:N){
    Pop_Vec[t] <-  Pop_Vec[t-1] *  ParamSeqDF$PAN_lambda_av[t] / ( 1+ (Pop_Vec[t-1]-1)*ParamSeqDF$PAN_alphaii_av[t] )
  }
  
  # PAL growth rates 
  left_join(data.frame(Temp = TempSeq), Av_PAL_vals, by = 'Temp') -> PAL_SeqDF
  PAL_r_vec = PAL_SeqDF$PAL_lambda_av / (1 + Pop_Vec* PAL_SeqDF$PAL_alphaij_av )
  MidTempDF$MeanPAN_FLUC[i] = mean(Pop_Vec[ 101:N ])           # drop first 100 as a burn in
  MidTempDF$PAL_Growth_FLUC[i] = exp(mean(log(PAL_r_vec[ 101:N ]  )))
  
  #########
  # Under steady state (following through in full, to make sure no artefacts)
  TempSeq = rep(MidTempDF$MidTemp[i], N)
  left_join(data.frame(Temp = TempSeq), Av_PAN_vals, by = 'Temp') -> ParamSeqDF
  
  # PAN counts
  Pop_Vec = rep(NA, N)
  Pop_Vec[1] <- 10
  for(t in 2:N){
    Pop_Vec[t] <-  Pop_Vec[t-1] *  ParamSeqDF$PAN_lambda_av[t] / ( 1+ (Pop_Vec[t-1]-1)*ParamSeqDF$PAN_alphaii_av[t] )
  }
  
  # PAL growth rates 
  left_join(data.frame(Temp = TempSeq), Av_PAL_vals, by = 'Temp') -> PAL_SeqDF
  PAL_r_vec = PAL_SeqDF$PAL_lambda_av / (1 + Pop_Vec* PAL_SeqDF$PAL_alphaij_av )
  MidTempDF$MeanPAN_FIX[i] = mean(Pop_Vec[ 101:N ])           # drop first 100 as a burn in
  #  MidTempDF$PAL_Growth_FIX[i] = mean(PAL_r_vec[ 101:N ]  )
  MidTempDF$PAL_Growth_FIX[i] = exp(mean(log(PAL_r_vec[ 101:N ]  )))
  
}
```

# Plotting Results

```{r}

MidTempDF %>%
  select( MidTemp,
          Fluctuating = PAL_Growth_FLUC,
          Fixed = PAL_Growth_FIX   ) %>%
  pivot_longer(names_to = 'Scenario',
               values_to = 'PAL Growth Rate' ,
               cols = -MidTemp)%>%
  ggplot(aes( x = MidTemp))+
  geom_point( aes( y = `PAL Growth Rate` , col = Scenario))+
  geom_hline( yintercept  =1)+
  theme_classic()

```


# Session Info

```{r}
sessionInfo()

```



